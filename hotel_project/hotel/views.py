from django.shortcuts import render, redirect
from .forms import ClientForm
from .models import Client
from .forms import ChambreForm
from .models import Chambre, ImageChambre
from .models import Reservation
from .forms import ReservationForm
from django.db.models import Q
from django.contrib import messages
from .models import ServiceReservation
from django.contrib import messages
from .forms import ServiceReservationForm
from datetime import date

def ajouter_client(request):
    if request.method == 'POST':
        form = ClientForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect('liste_clients')
    else:
        form = ClientForm()
    return render(request, 'ajouter_client.html', {'form': form})

def liste_clients(request):
    clients = Client.objects.all()
    return render(request, 'liste_clients.html', {'clients': clients})

def accueil(request):
    return render(request, 'accueil.html')

def ajouter_chambre(request):
    if request.method == 'POST':
        form = ChambreForm(request.POST)
        images = request.FILES.getlist('image')  # ← collecte des images
        if form.is_valid():
            chambre = form.save()
            for img in images:
                ImageChambre.objects.create(chambre=chambre, image=img)
            return redirect('liste_chambres')
    else:
        form = ChambreForm()
    return render(request, 'ajouter_chambre.html', {'form': form})

def liste_chambres(request):
    chambres = Chambre.objects.all()
    return render(request, 'liste_chambres.html', {'chambres': chambres})


def reserver_chambre(request):
    if request.method == 'POST':
        form = ReservationForm(request.POST)
        if form.is_valid():
            reservation = form.save(commit=False)

            # Vérifie si la date de début est dans le passé
            if reservation.date_debut < date.today():
                messages.error(request, "Vous ne pouvez pas réserver une chambre pour une date passée.")
                return redirect('reserver_chambre')

            # Vérifie si la chambre est déjà réservée pour la même période
            conflits = Reservation.objects.filter(
                chambre=reservation.chambre,
                date_debut__lt=reservation.date_fin,
                date_fin__gt=reservation.date_debut
            )

            if conflits.exists():
                messages.error(request, "Cette chambre est déjà réservée pour cette période.")
                return redirect('reserver_chambre')

            reservation.save()
            messages.success(request, "Réservation enregistrée avec succès.")
            return redirect('liste_reservations')
    else:
        form = ReservationForm()
    return render(request, 'reserver_chambre.html', {'form': form})


def liste_reservations(request):
    reservations = Reservation.objects.all()

    for reservation in reservations:
        services = ServiceReservation.objects.filter(reservation=reservation)
        total_services = sum([s.cout_total() for s in services])
        reservation.services = services
        reservation.total_services = total_services
        reservation.total_general = reservation.chambre.prix + total_services

    return render(request, 'liste_reservations.html', {'reservations': reservations})

def reserver_chambre(request):
    if request.method == 'POST':
        form = ReservationForm(request.POST)
        if form.is_valid():
            chambre = form.cleaned_data['chambre']
            date_debut = form.cleaned_data['date_debut']
            date_fin = form.cleaned_data['date_fin']

            # Vérifier les conflits
            conflits = Reservation.objects.filter(
                chambre=chambre,
                date_debut__lt=date_fin,
                date_fin__gt=date_debut
            )
            if conflits.exists():
                messages.error(request, "❌ Cette chambre est déjà réservée pour cette période.")
            else:
                form.save()
                messages.success(request, "✅ Réservation enregistrée avec succès.")
                return redirect('liste_reservations')
    else:
        form = ReservationForm()
    return render(request, 'reserver_chambre.html', {'form': form})

def ajouter_service_reservation(request):
    if request.method == 'POST':
        form = ServiceReservationForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "✅ Service ajouté à la réservation.")
            return redirect('liste_reservations')  # Ou une autre page
    else:
        form = ServiceReservationForm()
    return render(request, 'ajouter_service_reservation.html', {'form': form})


def rapport_reservations(request):
    reservations = Reservation.objects.select_related('chambre', 'client').all().order_by('-date_debut')
    return render(request, 'rapport_reservations.html', {'reservations': reservations})












